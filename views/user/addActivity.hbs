<form action="/user/courtmanagement/activity" method="POST" class="w-full max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-md my-5">
    <h1 class="text-2xl font-semibold mb-6">Aktivität hinzufügen</h1>

    <div class="mb-4">
        <label class="block mb-1 font-medium">Titel</label>
        <input type="text" name="title" placeholder="Instandsetzung 2025"
               class="w-full rounded-lg bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <div class="mb-4">
        <label class="block mb-1 font-medium">Gearbeitete Stunden</label>
        <input type="text" name="time" placeholder="3.5"
               class="w-full rounded-lg bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <div class="mb-4">
        <label class="block mb-1 font-medium">Datum</label>
        <input type="date" name="date" id="date"
               class="w-full rounded-lg bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
    </div>

    <div class="mb-4">
        <label class="block mb-1 font-medium">Mitglieder</label>
        <div class="grid gap-3 grid-cols-1 md:grid-cols-2 lg:grid-cols-3" id="members"></div>
    </div>

    <div class="mb-6">
        <label class="block mb-1 font-medium">Mitglieder hinzufügen</label>
        <div class="flex items-center bg-gray-100 py-2 rounded-lg">
            <input type="text" placeholder="Max Mustermann" id="addMembers" class="w-full px-3 h-full focus:outline-none" autocomplete="off">
            <img src="/media/svg/magnifying_glass.svg" class="h-[20px] mr-4" />
        </div>
        <table class="w-full text-left border-collapse" id="membersTable">
            <thead>
                <tr class="border-b">
                    <th class="py-2 font-medium pl-3">Name</th>
                </tr>
            </thead>
            <tbody id="memberList">
            </tbody>
        </table>
        <input type="hidden" name="users" id="userList" />
    </div>
    <input type="hidden" id="activityID" name="activityID" value=""/>

    <div class="flex justify-end gap-3">
        <button type="button"
                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition"
                onclick="window.location.href='/user/courtmanagement'">
            Abbrechen
        </button>
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" id="submitBtn">
            Speichern
        </button>
    </div>
</form>

<script>
    elAddMembers();
    setTodayDate();
    function elAddMembers(){
        const input = document.getElementById('addMembers');
        const user = {{{json user}}}
        input.addEventListener('input', (event) => {
            clearTbody();
            if(input.value.trim() != "" && input.value.trim().length >= 3){
                let txt = event.target.value.toLowerCase().split(" ");
                for(let i = 0; i < user.length; i++){
                    if(txt.length == 1){
                        if(user[i].firstname.toLowerCase().startsWith(txt[0]) || user[i].lastname.toLowerCase().startsWith(txt[0])){
                            showUser(user[i].firstname + " " + user[i].lastname);
                        }
                    }else{
                        if((user[i].firstname.toLowerCase() == txt[0] && user[i].lastname.toLowerCase().startsWith(txt[1])) || (user[i].lastname.toLowerCase() == txt[0] && user[i].firstname.toLowerCase().startsWith(txt[1]))){
                            showUser(user[i].firstname + " " + user[i].lastname);
                        }
                    }
                }
                elAddMemberToList();
            }
        })
    }

    function clearTbody() {
        const tbody = document.getElementById('memberList');
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
    }

    function showUser(name){
        const tbody = document.getElementById('memberList');
        let tr = document.createElement('tr');
        tr.classList.add(..."hover:bg-gray-100 cursor-pointer".split(" "));
        let td = document.createElement('td');
        td.innerText = name;
        td.classList.add(...'py-1 pl-3'.split(" "));
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
    
    function addUser(id, name){
        const container = document.getElementById('members');
        const ids = document.getElementById('userList');
        let div = document.createElement('div');
        div.classList.add(...'bg-gray-100 rounded-lg py-1 pl-3 flex justify-between items-center'.split(' '));
        div.innerText = name;
        let button = document.createElement('button');
        button.innerText = "x";
        button.classList.add(...'mr-4 hover:text-[17px] px-2 py-1'.split(' '));
        button.type="button";
        button.onclick = () => {removeUser(id,name)};
        div.appendChild(button);
        container.appendChild(div);
        if(ids.value != ""){
            ids.value = ids.value + ";" + id;
        }else{
            ids.value = id;
        }
    }

    function userAlreadyInserted(id){
        const ids = document.getElementById('userList');
        let txt = ids.value.split(";");
        for(let i = 0; i < txt.length; i++){
            if(txt[i] == id){
                return true;
            }
        }
        return false;
    }

    function setTodayDate(){
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');

        document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
    }
    
    function elAddMemberToList(){
        const tbody = document.getElementById('memberList');
        const childs = tbody.children;
        const user = {{{json user}}};
        for(let i = 0; i < childs.length; i++){
            childs[i].addEventListener('click', (event) => {
                let name = event.currentTarget.children[0].innerText;
                for(let j = 0; j < user.length; j++){
                    if(user[j].firstname + " " + user[j].lastname == name){
                        if(!userAlreadyInserted(user[j].userID)){
                            addUser(user[j].userID, name);
                        }
                    }
                }
            });
        }
    }

    function removeUser(id, name){
        const ids = document.getElementById('userList');
        const div = document.getElementById('members');
        let idsTxt = ids.value.split(";");
        let newTxt = "";
        for(let i = 0; i < idsTxt.length; i++){
            if(idsTxt[i] != id){
                newTxt += (idsTxt.length-1 != i)? idsTxt[i] + ";" : idsTxt[i];
            }
        }
        ids.value = newTxt;
        for(let i = 0; i < div.children.length; i++){
            if(div.children[i].innerText.split("x")[0].trim() == name){
                console.log(div.children[i]);
                div.removeChild(div.children[i]);
            }
        }
    }
    function replaceKomma(str){
        let newString = "";
        for(let i = 0; i < str.length; i++){
            if(str.substr(i,i+1) != ","){
                newString += str.substr(i,i+1);
            }else{
                newString += ".";
            }
        }
    }
    const form = document.querySelector('form');
    form.addEventListener('submit', (e) => {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; 
        btn.innerText = 'Bitte warten...'; 
    });


    {{#if activity}}
        console.log("activity");
        fillData();
        function fillData(){
            const activity = {{{json activity}}};
            document.querySelector("[name=title]").value = activity.title;
            document.querySelector("[name=time]").value = activity.time.toString();
            document.querySelector("[name=date]").value = activity.date;
            console.log(activity.activityID);
            document.getElementById('activityID').value = activity.activityID;
            console.log(document.getElementById('activityID').value);
            let user = activity.users;
            for(let i = 0; i < user.length; i++){
                addUser(user[i].userID, user[i].firstname + " " + user[i].lastname);
            }
        }
    {{/if}}

</script>
